<%- include('../partials/header', { title: 'Analytics' }) %>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">District Analytics</h1>
            <p class="text-gray-600 mt-2">Comprehensive analysis of attendance patterns and trends</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="exportAnalytics()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                <i class="fas fa-download mr-2"></i>
                Export Data
            </button>
            <button onclick="scheduleReport()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                <i class="fas fa-calendar-alt mr-2"></i>
                Schedule Report
            </button>
        </div>
    </div>

    <!-- Time Period Selector -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800">Analysis Period</h3>
            <div class="flex space-x-2">
                <button onclick="setPeriod('7d')" id="period7d" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors">
                    Last 7 Days
                </button>
                <button onclick="setPeriod('30d')" id="period30d" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-400 transition-colors">
                    Last 30 Days
                </button>
                <button onclick="setPeriod('90d')" id="period90d" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-400 transition-colors">
                    Last 90 Days
                </button>
                <button onclick="setPeriod('custom')" id="periodCustom" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-400 transition-colors">
                    Custom Range
                </button>
            </div>
        </div>
        
        <div id="customDateRange" class="mt-4 hidden">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                    <input type="date" id="fromDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                    <input type="date" id="toDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button onclick="applyCustomRange()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Apply Range
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">District Average</p>
                    <p class="text-3xl font-bold text-blue-600" id="districtAverage">91.2%</p>
                    <p class="text-sm text-green-600 mt-1">
                        <i class="fas fa-arrow-up mr-1"></i>
                        +2.3% from last period
                    </p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Best Performing</p>
                    <p class="text-3xl font-bold text-green-600" id="bestPerforming">96.8%</p>
                    <p class="text-sm text-gray-600 mt-1">Greenfield Primary</p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fas fa-trophy text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Needs Attention</p>
                    <p class="text-3xl font-bold text-red-600" id="needsAttention">3</p>
                    <p class="text-sm text-gray-600 mt-1">Schools below 80%</p>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Students</p>
                    <p class="text-3xl font-bold text-purple-600" id="totalStudents">2,847</p>
                    <p class="text-sm text-gray-600 mt-1">Across all schools</p>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="fas fa-users text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- District Trend Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                District Attendance Trend
            </h3>
            <div class="h-80">
                <canvas id="districtTrendChart"></canvas>
            </div>
        </div>

        <!-- School Comparison Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                School Performance Comparison
            </h3>
            <div class="h-80">
                <canvas id="schoolComparisonChart"></canvas>
            </div>
        </div>
    </div>

    <!-- District Statistics Table -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fas fa-table mr-2 text-purple-600"></i>
                District-wise Performance
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">District</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schools</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Students</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Attendance</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dropout Risk</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <% if (Object.keys(districtStats).length === 0) { %>
                        <tr>
                            <td colspan="7" class="text-center py-8 text-gray-500 text-lg">No analytics data available.</td>
                        </tr>
                    <% } else { %>
                        <% Object.keys(districtStats).forEach(district => { %>
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                            <i class="fas fa-map-marker-alt text-indigo-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900"><%= district %></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <%= districtStats[district].schools %>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <%= districtStats[district].totalStudents %>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="text-sm font-medium text-gray-900"><%= districtStats[district].avgAttendance %>%</div>
                                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-<%= parseFloat(districtStats[district].avgAttendance) >= 85 ? 'green' : parseFloat(districtStats[district].avgAttendance) >= 75 ? 'yellow' : 'red' %>-600 h-2 rounded-full" 
                                             style="width: <%= districtStats[district].avgAttendance %>%;"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <% const riskLevel = parseFloat(districtStats[district].avgDropoutRisk) > 15 ? 'high' : parseFloat(districtStats[district].avgDropoutRisk) > 8 ? 'medium' : 'low'; %>
                                <% const riskColor = riskLevel === 'high' ? 'red' : riskLevel === 'medium' ? 'yellow' : 'green'; %>
                                <span class="px-2 py-1 text-xs font-medium bg-<%= riskColor %>-100 text-<%= riskColor %>-800 rounded-full">
                                    <%= districtStats[district].avgDropoutRisk %>%
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <% const trend = Math.random() > 0.5 ? 'up' : 'down'; %>
                                <% const trendColor = trend === 'up' ? 'green' : 'red'; %>
                                <span class="text-<%= trendColor %>-600">
                                    <i class="fas fa-arrow-<%= trend %> mr-1"></i>
                                    <%= trend === 'up' ? '+' : '-' %><%= (Math.random() * 5).toFixed(1) %>%
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <% const status = parseFloat(districtStats[district].avgAttendance) >= 85 ? 'excellent' : parseFloat(districtStats[district].avgAttendance) >= 75 ? 'good' : 'attention'; %>
                                <% const statusColor = status === 'excellent' ? 'green' : status === 'good' ? 'blue' : 'red'; %>
                                <span class="px-2 py-1 text-xs font-medium bg-<%= statusColor %>-100 text-<%= statusColor %>-800 rounded-full">
                                    <%= status === 'excellent' ? 'Excellent' : status === 'good' ? 'Good' : 'Needs Attention' %>
                                </span>
                            </td>
                        </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Insights and Recommendations -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Key Insights -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>
                Key Insights
            </h3>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800">Attendance Improvement</h4>
                            <p class="text-sm text-blue-700 mt-1">
                                District-wide attendance has improved by 2.3% compared to the previous period, 
                                indicating positive trends in student engagement.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-yellow-800">Schools Needing Support</h4>
                            <p class="text-sm text-yellow-700 mt-1">
                                3 schools are performing below the 80% attendance threshold and require 
                                immediate intervention and support programs.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-green-800">Best Practices</h4>
                            <p class="text-sm text-green-700 mt-1">
                                Top-performing schools are successfully implementing RFID-based attendance 
                                systems with 96%+ accuracy rates.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-clipboard-list mr-2 text-green-600"></i>
                Recommendations
            </h3>
            
            <div class="space-y-4">
                <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <span class="text-sm font-bold text-blue-600">1</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">Implement Intervention Programs</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            Deploy targeted support programs for schools with attendance rates below 80%.
                        </p>
                    </div>
                </div>
                
                <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <span class="text-sm font-bold text-green-600">2</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">Expand RFID Coverage</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            Roll out RFID attendance systems to remaining schools to improve accuracy.
                        </p>
                    </div>
                </div>
                
                <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <span class="text-sm font-bold text-purple-600">3</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">Parent Engagement</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            Increase parent notification systems to improve student attendance rates.
                        </p>
                    </div>
                </div>
                
                <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                        <span class="text-sm font-bold text-orange-600">4</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">Teacher Training</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            Provide additional training on dropout prediction and early intervention.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPeriod = '7d';

    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        createDistrictTrendChart();
        createSchoolComparisonChart();
    });

    function setPeriod(period) {
        currentPeriod = period;
        
        // Update button states
        ['7d', '30d', '90d', 'custom'].forEach(p => {
            const btn = document.getElementById(`period${p}`);
            if (p === period) {
                btn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors';
            } else {
                btn.className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-400 transition-colors';
            }
        });
        
        // Show/hide custom date range
        const customRange = document.getElementById('customDateRange');
        if (period === 'custom') {
            customRange.classList.remove('hidden');
        } else {
            customRange.classList.add('hidden');
            updateAnalytics();
        }
    }

    function applyCustomRange() {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        
        if (fromDate && toDate) {
            updateAnalytics();
        } else {
            alert('Please select both from and to dates');
        }
    }

    function updateAnalytics() {
        // Simulate data update based on period
        showToast('Updating analytics data...', 'info');
        
        setTimeout(() => {
            // Update charts with new data
            createDistrictTrendChart();
            createSchoolComparisonChart();
            showToast('Analytics updated successfully!', 'success');
        }, 1500);
    }

    function createDistrictTrendChart() {
        const ctx = document.getElementById('districtTrendChart').getContext('2d');
        
        // Generate sample data based on current period
        const days = currentPeriod === '7d' ? 7 : currentPeriod === '30d' ? 30 : 90;
        const labels = [];
        const data = [];
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            // Generate realistic trend data
            const baseRate = 90;
            const variation = Math.sin(i / 7) * 3 + Math.random() * 4;
            data.push(Math.max(85, Math.min(95, baseRate + variation)));
        }
        
        // Destroy existing chart if it exists
        if (window.districtChart) {
            window.districtChart.destroy();
        }
        
        window.districtChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'District Average (%)',
                    data: data,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 80,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxTicksLimit: 10
                        }
                    }
                }
            }
        });
    }

    function createSchoolComparisonChart() {
        const ctx = document.getElementById('schoolComparisonChart').getContext('2d');
        
        const schools = ['Greenfield Primary', 'Riverside Elementary', 'Mountain View School', 'Valley High', 'Sunset Academy'];
        const attendanceRates = [96.8, 94.2, 91.5, 88.7, 85.3];
        
        // Destroy existing chart if it exists
        if (window.comparisonChart) {
            window.comparisonChart.destroy();
        }
        
        window.comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: schools,
                datasets: [{
                    label: 'Attendance Rate (%)',
                    data: attendanceRates,
                    backgroundColor: attendanceRates.map(rate => 
                        rate >= 95 ? '#10B981' : 
                        rate >= 90 ? '#3B82F6' : 
                        rate >= 85 ? '#F59E0B' : '#EF4444'
                    ),
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 80,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45
                        }
                    }
                }
            }
        });
    }

    function exportAnalytics() {
        showToast('Preparing analytics export...', 'info');
        setTimeout(() => {
            showToast('Analytics data exported successfully!', 'success');
        }, 2000);
    }

    function scheduleReport() {
        showToast('Report scheduling feature coming soon!', 'info');
    }

    function showToast(message, type) {
        const colors = {
            success: 'bg-green-600',
            info: 'bg-blue-600',
            warning: 'bg-yellow-600',
            error: 'bg-red-600'
        };
        
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-3"></i>
                ${message}
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>

<%- include('../partials/footer') %>